## DO NOT EDIT THIS FILE.
# This file is part of a git repository, your changes may prevent updates

[mcu]
serial: /dev/ttyS2
restart_method: command

[mcu U_1]
serial: /dev/ttyS0
restart_method: command

[respond]
default_type: echo

[resonance_tester]
accel_per_hz: 150
max_smoothing:0.5

[duplicate_pin_override]
pins:
     gpio21 ,U_1:PC3

[force_move]
enable_force_move : True

[bed_screws]
screw1:10,10
screw1_name: Front left
screw2: 230,10
screw2_name: Front right
screw3: 125,240
screw3_name: Back right
probe_height: 0.2
horizontal_move_z: 10

#[screws_tilt_adjust]
# screw1:10,10
# screw1_name: Front left
# screw2: 220,10
# screw2_name: Front right
# screw3: 125,230
# screw3_name: Back right
# screw_thread: CW-M4

[screws_tilt_adjust]
screw1:0,17
screw1_name: Front left
screw2: 196,17
screw2_name: Front right
screw3: 91,230
screw3_name: Back right
screw_thread: CW-M4 

[hall_filament_width_sensor]
adc1: gpio27
adc2: gpio28
cal_dia1: 1.48 # calibration data from author's unit
cal_dia2: 1.97 # this hall effect filament sensor is kinda useless as width sensor actually,
raw_dia1: 13422 # because the inlet is not mounted rigidly, the filament will pivot and make the reading really high when bend to the left
raw_dia2: 14765
default_nominal_filament_diameter: 1.75
max_difference: 0
measurement_delay: 102
enable: false
measurement_interval: 10
logging: False
min_diameter: 1.0
max_diameter: 2.7
use_current_dia_while_delay: False
pause_on_runout: True
runout_gcode:
            PAUSE
            RESET_FILAMENT_WIDTH_SENSOR
            M118 Filament run out
event_delay: 3.0
pause_delay: 0.5

[extruder]
step_pin:gpio5
dir_pin:gpio4
enable_pin:!gpio10
rotation_distance: 53.7  #22.6789511    #Bondtech 5mm Drive Gears
gear_ratio: 1517:170
microsteps: 16
full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
min_temp: 0
max_temp: 360
min_extrude_temp: 175
smooth_time: 0.000001
heater_pin:gpio24
sensor_type:MAX6675
sensor_pin:gpio17
spi_software_sclk_pin:gpio18
spi_software_mosi_pin:gpio19
spi_software_miso_pin:gpio16
spi_speed: 100000
max_power: 1
control : pid
pid_Kp=33.555
pid_Ki=4.76
pid_Kd=59.141
pressure_advance: 0.032
pressure_advance_smooth_time: 0.03
max_extrude_cross_section:500
instantaneous_corner_velocity: 10.000
max_extrude_only_distance: 1000.0
max_extrude_only_velocity:5000
max_extrude_only_accel:2000
step_pulse_duration:0.000002

[tmc2209 extruder]
uart_pin:gpio6
interpolate: True
run_current: 0.714
stealthchop_threshold: 0

[adxl345]
cs_pin:gpio13
spi_software_sclk_pin:gpio14
spi_software_mosi_pin:gpio15
spi_software_miso_pin:gpio12
axes_map: -x, z, -y

[printer]
kinematics:corexy
max_velocity: 600
max_accel: 20000
max_z_velocity: 10
max_z_accel: 500
square_corner_velocity: 8

[stepper_x]
step_pin:U_1:PB4
dir_pin:!U_1:PB3
enable_pin:!U_1:PB5
microsteps:16
rotation_distance: 39.88
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:tmc2240_stepper_x:virtual_endstop
position_min: -5.5
position_endstop: -5.5
position_max:245
homing_speed:50
homing_retract_dist:0
homing_positive_dir:False
step_pulse_duration:0.0000001

[stepper_y]
step_pin:U_1:PC14
dir_pin:!U_1:PC13
enable_pin:!U_1:PC15
microsteps: 16
rotation_distance: 39.88
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin:tmc2240_stepper_y:virtual_endstop
position_min: -4.5
position_endstop: -4.5
position_max: 258
homing_speed:50
homing_retract_dist:0
homing_positive_dir:False
step_pulse_duration:0.0000001

[stepper_z]
step_pin:U_1:PC10
dir_pin:U_1:PA15
enable_pin:!U_1:PC11
microsteps: 128
rotation_distance: 4
full_steps_per_rotation: 200
endstop_pin: probe:z_virtual_endstop #eddy endstop
position_max: 248
position_min: -4
homing_speed: 8
second_homing_speed: 10
homing_retract_dist: 5.0
homing_positive_dir:false

[stepper_z1]
step_pin:U_1:PB1
dir_pin:U_1:PB6
enable_pin:!U_1:PB0
microsteps: 128
rotation_distance: 4
full_steps_per_rotation: 200
step_pulse_duration:0.0000001

[z_tilt]
z_positions:
    -59,125
    306,125

points:
    0, 118 # 0-34=eddy x (0) , 125-7=eddy y (118) 
    196, 118 # 245-34=eddy x (191) , 125-7=eddy y (118)

speed: 150
horizontal_move_z: 5
retries: 3
retry_tolerance: 0.05

# [z_tilt]
# z_positions:
#     -59,125
#    307.5,125
# 
# points:
#     0,125
#     215,125
# 
# speed: 150
# horizontal_move_z: 5
# retries: 2
# retry_tolerance: 0.05

[tmc2240 stepper_y]
cs_pin: U_1:PB9
spi_software_sclk_pin: U_1:PA5
spi_software_mosi_pin: U_1:PA7
spi_software_miso_pin: U_1:PA6
spi_speed: 200000
run_current: 1.07
interpolate: true
stealthchop_threshold: 0
coolstep_threshold: 15
diag0_pin: !U_1:PC0
driver_SGT: 1

[tmc2240 stepper_x]
cs_pin: U_1:PD2
spi_software_sclk_pin: U_1:PA5
spi_software_mosi_pin: U_1:PA7
spi_software_miso_pin: U_1:PA6
spi_speed: 200000
run_current: 1.07
interpolate: true
stealthchop_threshold: 0
coolstep_threshold: 15
diag0_pin: !U_1:PB8
driver_SGT: 1

[tmc2209 stepper_z]
uart_pin:U_1: PC5
run_current: 0.6
interpolate: True
stealthchop_threshold: 9999999999

[tmc2209 stepper_z1]
uart_pin:U_1: PB7
run_current: 0.6
interpolate: True
stealthchop_threshold: 9999999999

[heater_bed]
heater_pin: U_1:PB10
sensor_type:NTC 100K MGB18-104F39050L32
sensor_pin:U_1: PA0
max_power: 1.0
control = pid
pid_Kp=63.418
pid_Ki=1.342
pid_Kd=749.125
min_temp: -60
max_temp: 125

[heater_generic chamber]
heater_pin:U_1:PC8
max_power:1.0
sensor_type:NTC 100K MGB18-104F39050L32
sensor_pin:U_1:PA1
control = pid
#max_delta: 1.0
pid_Kp=63.418
pid_Ki=1.342
pid_Kd=749.125

min_temp:-100
max_temp:62

[verify_heater chamber]
max_error: 300
check_gain_time:480
hysteresis: 5
heating_gain: 1

[verify_heater extruder]
max_error: 120
check_gain_time:20
hysteresis: 5
heating_gain: 1

[verify_heater heater_bed]
max_error: 200
check_gain_time:60
hysteresis: 5
heating_gain: 1

[fan_generic auxiliary_cooling_fan]
pin: U_1:PA8
shutdown_speed: 0.0
cycle_time: 0.0100
hardware_pwm: false
kick_start_time: 0.100
off_below: 0.0

[fan_generic chamber_circulation_fan]
pin:U_1:PC9
shutdown_speed: 0.0
cycle_time: 0.100
hardware_pwm: false
kick_start_time: 0.100
off_below: 0.0

[heater_fan chamber_fan]
pin:U_1:PA4
max_power: 1.0
shutdown_speed: 0
kick_start_time: 0.5
heater: chamber
heater_temp: 35
fan_speed: 1.0
off_below: 0

[heater_fan hotend_fan]
pin:gpio25
max_power: 1.0
shutdown_speed:1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 65.0
fan_speed: 1.0
off_below: 0

[heater_fan hotend_fan2]
pin:gpio11
max_power: 1.0
shutdown_speed:1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 65.0
fan_speed: 1.0
off_below: 0

[fan_generic cooling_fan]
pin:gpio2
max_power: 1.0
shutdown_speed: 0
cycle_time: 0.0100
hardware_pwm: false
kick_start_time: 0.100
off_below: 0.0

[temperature_sensor host]
sensor_type: temperature_host

[temperature_sensor toolhead_board_mcu]
sensor_type: temperature_mcu

[temperature_sensor mainboard_mcu]
sensor_type: temperature_mcu
sensor_mcu: U_1

[fan_generic board_fan]
pin:U_1:PC4
max_power:1.0
shutdown_speed:1.0

[delayed_gcode board_fan_control]
;description: 2-point linear fan curve control with hysteresis at the off/min state, basically default "watermark" control, but can go to 100% when printed in a heated chamber and extra cooling is needed, or just bang-bang with 20% when idle.
initial_duration: 1.
gcode:
    {% set t_off = 60 %} ; fan will turn off after dropping below this temperature at min_speed
    {% set t_on = 70 %} ; fan will turn on at "min_speed" after rising above this temperature
    {% set t_max = 80 %} ; fan is max at this temperature
    {% set t_tmcmax = 100.0 %} ; fan is max at this tmc2240 temperature
    {% set min_speed = 0.2 %} ; if fan speed should be between 0 and min_speed, min_speed will be used

    {% set temp_x = printer['tmc2240 stepper_x'].temperature|default(0)|float %}
    {% set temp_y = printer['tmc2240 stepper_y'].temperature|default(0)|float %}
    {% set temp_host = printer['temperature_sensor host'].temperature|default(0)|float %}
    {% set temp_mcu = printer['temperature_sensor mainboard_mcu'].temperature|default(0)|float %}
    {% set max_temp = ([temp_host, temp_mcu, temp_x / t_tmcmax * t_max, temp_y / t_tmcmax * t_max] | sort)[-1] %}
    ; max detected temperature on the electronics bay

    {% if ( max_temp >= t_on ) %}
        {% set fan_speed = ([( [max_temp - t_on, t_max - t_on] | min), 0] | max) / (t_max - t_on) * (1.0 - min_speed) + min_speed %}
        {% if (fan_speed > 0) and (fan_speed < min_speed) %}
            {% set fan_speed = min_speed %}
        {% endif %}
        SET_FAN_SPEED FAN=board_fan SPEED={fan_speed}
    {% elif max_temp < t_off %}
        SET_FAN_SPEED FAN=board_fan SPEED=0
    {% elif printer['fan_generic board_fan'].speed > 0 %}
        SET_FAN_SPEED FAN=board_fan SPEED={min_speed}
    {% endif %}

    UPDATE_DELAYED_GCODE ID=board_fan_control DURATION=1

#[probe]
#pin: !gpio21
#x_offset: 17.6
#y_offset: 4.4
#z_offset: 0.0
#speed: 10
#samples: 3
#samples_result: average
#sample_retract_dist: 4.0
#samples_tolerance: 0.05
#samples_tolerance_retries: 5

#[auto_z_offset]
#pin: U_1:PC1
#z_offset: -0.07
#speed: 10
#probe_accel: 50
#samples: 5
#samples_result: average
#samples_tolerance: 0.05
#samples_tolerance_retries: 5
#prepare_gcode:
#    SET_PIN PIN=bed_sensor VALUE=0
#    G91
#    {% set i = 4 %}
#    {% for iteration in range(i|int) %}
#        G1 Z1 F900
#        G1 Z-1 F900
#    {% endfor %}
#    G90
#   SET_PIN PIN=bed_sensor VALUE=1

[output_pin caselight]
pin: U_1:PC7
pwm: false
shutdown_value:1
value:1

[output_pin beeper]
pin:U_1: PA2
pwm: false
shutdown_value:0
value:0

[output_pin sound]
pin: U_1:PA13
value:0

[output_pin bed_sensor]
pin: !U_1:PA14
value:0

[filament_switch_sensor tangle]
pause_on_runout: True
runout_gcode:
            PAUSE
event_delay: 3.0
pause_delay: 0.5
switch_pin:U_1:PC3

[resonance_tester]
accel_chip: adxl345
probe_points:
   120, 120, 10

[gcode_arcs]
resolution: 1.0

[pause_resume]

[display_status]

[exclude_object]

[idle_timeout]
gcode:
    TURN_OFF_HEATERS
    M84
timeout: 600
